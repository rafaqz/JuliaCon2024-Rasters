---
title: "Rasters.jl"
subtitle: "Geospatial raster data reading, writing and manipulation"
author:
  - name: Rafael Schouten
    orcid:
    email: rafaelschouten@gmail.com
    affiliation:
      - name: Globe Intstitute, Copenhagen University
      - department: Section for Biodiversity
date: "2024-07-10"
engine: julia
format:
  revealjs:
    theme: [simple, style.scss] # beige blood dark default league moon night serif simple sky solarized
    incremental: true
    toc: false
    toc-depth: 2
    slide-number: true
    overview: true
    code-line-numbers: false
execute:
    echo: true
---

## Read/Write Backends

File types                      | Package
------------------------------- | ----------
Netcdf/hdf5                     | NCDatasets.jl
Grib (read only)                | GRIBDatasets.jl
Zarr (PR nearly done!)          | ZarrDatasets.jl
R grd (simple Mmap data from R) | native
GeoTIFF and everything else     | ArchGDAL.jl


## Backend detection

From filename extension:

```julia
# Single array
rast = Raster("myrasterfile.ext")

# Multi-array
st = RasterStack("myrasterstack.ext")

# Series of rasters or stacks may be detectable from folders
st = RasterSeries("myrasterfolder", Ti(DateTime))
```

# Lazy loading

For manipulating larger-than-memory data

## DiskArrays.jl integration  

Loads data lazily:

```julia
rast = Raster(filename; lazy=true)
```

Still lazy after broadcasts:
```julia
rast10 = rast .* 10
```

Reads from disk/network only on `getindex`:
```julia
rast10[X=100 .. 135, Y=20 .. 40]
```

Or `read`:
```julia
read(rast10)
```

## Change chunk patterns 
For more efficient lazy reads:
\
```julia
write("rechunked.tif", raster; chunks=(256, 256))
```

## RasterDataSources.jl integration

```{julia}
#| echo: false
ENV["RASTERDATASOURCES_PATH"] = "/home/raf/Data/Raster";
```
\
Load a raster from RasterDataSources.jl filename:

```{julia}
using Rasters, RasterDataSources, ArchGDAL
bioclim_filename = RasterDataSources.getraster(WorldClim{BioClim}, 5)
bioclim5 = Raster(bioclim_filename);
```
\
Or use RasterDataSources.jl syntax directly:

```{julia}
bioclim_filename = Raster(WorldClim{BioClim}, 5);
```

# Plotting

Always the right way up!

## Plots.jl

```{julia}
using Plots
Plots.plot(bioclim5)
```

## Makie.jl

```{julia}
#| echo: false
using CairoMakie
CairoMakie.activate!(type = "png")
```

```{julia}
using CairoMakie
Makie.plot(bioclim5)
```

## GeoMakie.jl

```{julia}
using GeoMakie
fig = Figure();
ga = GeoAxis(fig[1, 1]; dest="+proj=ortho +lon_0=19 +lat_0=72")
Makie.heatmap!(ga, bioclim5)
fig
```


# Common GIS methods

## Native rasterization engine

- accepts all GeoInterface.jl geometries
- extremely fast + threaded
- detailed correctness warnings
- consistent behaviour and syntax for:
  - `rasterize`
  - `coverage`
  - `mask`
  - `boolmask`/`missingmask`
  - `zonal`

## Other common methods

- extract
- crop/extend
- trim
- mosaic
- aggregate
- resample

# Examples
\
```{julia}
using Rasters
using ArchGDAL
using Dates
using DataFrames
using GBIF2
using NaturalEarth
using RasterDataSources
```

```{julia}
#| echo: false
using Rasters: trim
```

## `extract`

Extract climate data at specific points:

```{julia}
#| output-location: fragment
clim = RasterStack(WorldClim{BioClim})
occ = GBIF2.occurrence_search("Burramys parvus")
# occ is a table with a `:geometry` column, so this "just works"
extract(clim, occ; name=(:bio1, :bio4, :bio7)) |> DataFrame
```

## `mask` + `trim`

Mask climate data wth country border and trim:

---
code-annotations: hover
---

```{julia}
#| output-location: fragment
clim = RasterStack(WorldClim{Climate}, (:tmin, :tmax, :prec, :wind); month=July)
countries = naturalearth("ne_10m_admin_0_countries") |> DataFrame
norway = subset(countries, :NAME => ByRow(==("Norway"))).geometry
norway_clim = mask(clim; with=norway)[Y=0 .. 90] |> trim
Plots.plot(norway_clim; size=(800, 400))
```

## `zonal` statistics

```{julia}
#| echo: false
using Rasters, RasterDataSources, ArchGDAL, Dates, DataFrames, NaturalEarth, Statistics
```

Find the hottest and coldest countries in July:

```{julia}
#| output-location: fragment
clim = Raster(WorldClim{Climate}, :tmax; month=July)
countries = naturalearth("ne_10m_admin_0_countries") |> DataFrame
countries.july_maxtemp = zonal(Statistics.mean, clim; 
    of=countries, boundary=:touches, progress=false
)
filtered = subset(countries, :july_maxtemp => ByRow(!isnan))
sort!(filtered, :july_maxtemp).NAME
```

# Thanks!

Any problems, make github issues at\
https://github.com/rafaqz/Rasters.jl
\
\
Please include all files in a MWE!
